## Codebase Patterns

- Use `getSandbox` from `@cloudflare/sandbox` to create sandbox instances
- Export `Sandbox` from index.ts for Cloudflare container runtime
- Prompts are stored in `/prompts/` directory and copied into container
- SPEC.md contains the complete API specification and framework templates
- Auth middleware: `requireAuth(request, env)` returns `{ success: true }` or `{ success: false, response: Response }`
- Job state: Use `createJob(request)`, `getJob(id)`, `updateJob(id, updates)` from src/jobs.ts
- Types: Job, JobStatus, ExploreRequest, ExploreMode, ModelType are all exported from src/jobs.ts

---

# Progress Log

## Initial State Assessment
- Dockerfile exists with sandbox base image, but uses 5-min timeout instead of 15-min
- Prompts (business.md, exploration.md) already created
- Basic worker exists with POST endpoint for repo/task, needs refactoring for idea exploration API
- wrangler.jsonc configured for containers

---

## 2026-01-08 - US-001
Thread: https://ampcode.com/threads/T-019b9c40-8f37-7509-9f6c-a7abd0a62ff3
- Verified Dockerfile configuration meets all acceptance criteria
- Dockerfile extends cloudflare/sandbox:0.6.10
- Claude Code installed via `npm install -g @anthropic-ai/claude-code`
- 15-minute timeout configured (COMMAND_TIMEOUT_MS=900000)
- Prompts directory copied to /prompts/
- Files changed: Dockerfile (already updated in prior session, just committed)
- **Learnings for future iterations:**
  - Dockerfile was already updated but uncommitted - always check git status first
  - typecheck command is `bun run typecheck`
---

## 2026-01-08 - US-002
Thread: https://ampcode.com/threads/T-019b9c41-bb15-75da-9340-64944492a1f0
- Verified prompt templates match SPEC.md structure
- prompts/business.md: Contains Problem Analysis, Market Assessment, Technical Feasibility, Verdict sections
- prompts/exploration.md: Contains Core Insight Deconstruction, Directions to Explore, Unexpected Connections, Questions Worth Answering sections
- Files changed: None (prompts already correct)
- **Learnings for future iterations:**
  - Prompts include Input Variables section for IDEA and CONTEXT placeholders
  - Templates use markdown code blocks to show the exact output format expected
---

## 2026-01-08 - US-003
Thread: https://ampcode.com/threads/T-019b9c42-9c8c-7208-b38e-675284cab051
- Implemented Bearer token authentication middleware
- Created src/middleware/auth.ts with requireAuth function
- Validates Authorization: Bearer <token> header against API_BEARER_TOKEN env var
- Returns 401 with JSON error message for missing/invalid/wrong tokens
- Files changed: src/middleware/auth.ts (new)
- **Learnings for future iterations:**
  - Use `type` instead of `interface` for union types in TypeScript
  - Auth middleware exports AuthEnv interface for type-safe env access
  - Use requireAuth(request, env) and check result.success before proceeding
---

## 2026-01-08 - US-004
Thread: https://ampcode.com/threads/T-019b9c44-0213-77ef-b4ea-46538ef4b954
- Implemented job types and in-memory state management
- Created src/jobs.ts with:
  - JobStatus type: 'pending' | 'running' | 'completed' | 'failed'
  - ExploreMode and ModelType helper types
  - ExploreRequest interface matching API spec
  - Job interface with all required fields
  - In-memory Map storage for jobs
  - createJob, getJob, updateJob utility functions
- Files changed: src/jobs.ts (new)
- **Learnings for future iterations:**
  - Use `Partial<Omit<Job, 'id' | 'created_at'>>` pattern for update functions to prevent modifying immutable fields
  - crypto.randomUUID().slice(0, 8) generates short job IDs
---
