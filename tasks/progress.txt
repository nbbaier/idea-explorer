## Codebase Patterns

- Use `getSandbox` from `@cloudflare/sandbox` to create sandbox instances
- Export `Sandbox` from index.ts for Cloudflare container runtime
- Prompts are stored in `/prompts/` directory and copied into container
- SPEC.md contains the complete API specification and framework templates
- Auth middleware: `requireAuth(request, env)` returns `{ success: true }` or `{ success: false, response: Response }`
- Job state: Use `createJob(request)`, `getJob(id)`, `updateJob(id, updates)` from src/jobs.ts
- Types: Job, JobStatus, ExploreRequest, ExploreMode, ModelType are all exported from src/jobs.ts
- Type Sandbox namespace as `DurableObjectNamespace<Sandbox>` (import Sandbox from @cloudflare/sandbox)
- Git auth in containers: Use `https://x-access-token:$GITHUB_PAT@github.com/<repo>.git` for PAT-based cloning
- Use `generateSlug` from src/utils/slug.ts for URL-safe slugs (max 50 chars, kebab-case)
- Container env vars: Pass to sandbox via `sandbox.setEnvVars({ KEY: value })` before running commands
- Webhook: Use `sendWebhook(job, githubRepo, branch)` from src/utils/webhook.ts for webhook delivery with HMAC-SHA256 signatures
- Logging: Use `logInfo(jobId, event, data?)` and `logError(jobId, operation, error)` for structured JSON logging with job_id context
- Retry pattern: Use `cloneWithRetry` and `pushWithRetry` in src/index.ts for git operations with retry logic

---

# Progress Log

## Initial State Assessment
- Dockerfile exists with sandbox base image, but uses 5-min timeout instead of 15-min
- Prompts (business.md, exploration.md) already created
- Basic worker exists with POST endpoint for repo/task, needs refactoring for idea exploration API
- wrangler.jsonc configured for containers

---

## 2026-01-08 - US-001
Thread: https://ampcode.com/threads/T-019b9c40-8f37-7509-9f6c-a7abd0a62ff3
- Verified Dockerfile configuration meets all acceptance criteria
- Dockerfile extends cloudflare/sandbox:0.6.10
- Claude Code installed via `npm install -g @anthropic-ai/claude-code`
- 15-minute timeout configured (COMMAND_TIMEOUT_MS=900000)
- Prompts directory copied to /prompts/
- Files changed: Dockerfile (already updated in prior session, just committed)
- **Learnings for future iterations:**
  - Dockerfile was already updated but uncommitted - always check git status first
  - typecheck command is `bun run typecheck`
---

## 2026-01-08 - US-002
Thread: https://ampcode.com/threads/T-019b9c41-bb15-75da-9340-64944492a1f0
- Verified prompt templates match SPEC.md structure
- prompts/business.md: Contains Problem Analysis, Market Assessment, Technical Feasibility, Verdict sections
- prompts/exploration.md: Contains Core Insight Deconstruction, Directions to Explore, Unexpected Connections, Questions Worth Answering sections
- Files changed: None (prompts already correct)
- **Learnings for future iterations:**
  - Prompts include Input Variables section for IDEA and CONTEXT placeholders
  - Templates use markdown code blocks to show the exact output format expected
---

## 2026-01-08 - US-003
Thread: https://ampcode.com/threads/T-019b9c42-9c8c-7208-b38e-675284cab051
- Implemented Bearer token authentication middleware
- Created src/middleware/auth.ts with requireAuth function
- Validates Authorization: Bearer <token> header against API_BEARER_TOKEN env var
- Returns 401 with JSON error message for missing/invalid/wrong tokens
- Files changed: src/middleware/auth.ts (new)
- **Learnings for future iterations:**
  - Use `type` instead of `interface` for union types in TypeScript
  - Auth middleware exports AuthEnv interface for type-safe env access
  - Use requireAuth(request, env) and check result.success before proceeding
---

## 2026-01-08 - US-004
Thread: https://ampcode.com/threads/T-019b9c44-0213-77ef-b4ea-46538ef4b954
- Implemented job types and in-memory state management
- Created src/jobs.ts with:
  - JobStatus type: 'pending' | 'running' | 'completed' | 'failed'
  - ExploreMode and ModelType helper types
  - ExploreRequest interface matching API spec
  - Job interface with all required fields
  - In-memory Map storage for jobs
  - createJob, getJob, updateJob utility functions
- Files changed: src/jobs.ts (new)
- **Learnings for future iterations:**
  - Use `Partial<Omit<Job, 'id' | 'created_at'>>` pattern for update functions to prevent modifying immutable fields
  - crypto.randomUUID().slice(0, 8) generates short job IDs
---

## 2026-01-08 - US-005
Thread: https://ampcode.com/threads/T-019b9e36-ae53-7543-824d-322df5cdad41
- Implemented POST /explore endpoint
- Refactored src/index.ts to:
  - Add /explore route with POST handler
  - Validate request body with isValidExploreRequest type guard
  - Integrate auth middleware (401 for invalid token)
  - Return 400 for missing/invalid required fields (idea, webhook_url)
  - Create job via createJob() and return 202 with job_id and status
  - Spawn async container execution with runExploration()
- Files changed: src/index.ts
- **Learnings for future iterations:**
  - Import Sandbox from @cloudflare/sandbox and use `DurableObjectNamespace<Sandbox>` for proper typing
  - Use type guard functions for request validation to get proper TypeScript narrowing
  - Fire-and-forget async execution pattern: call async function without await to return immediately
---

## 2026-01-08 - US-006
Thread: https://ampcode.com/threads/T-019b9e38-9034-709e-b315-4839e9b9659b
- Implemented GET /status/{job_id} endpoint
- Added regex path matching for /status/:job_id route
- Returns job status, idea, mode; conditionally includes github_url (completed) or error (failed)
- Returns 404 for unknown job_id
- Uses auth middleware
- Files changed: src/index.ts
- **Learnings for future iterations:**
  - Use regex path matching `url.pathname.match(/^\/status\/([^/]+)$/)` for dynamic route segments
  - Build response object conditionally to only include relevant fields per status
---

## 2026-01-08 - US-008
Thread: https://ampcode.com/threads/T-019b9e3b-2167-76bf-a36d-48ea7816c5c4
- Implemented full container execution flow
- Added GITHUB_PAT, GITHUB_REPO, GITHUB_BRANCH to ExploreEnv interface
- Refactored runExploration() to:
  - Clone ideas repo with PAT authentication: `git clone --depth 1 --branch <branch> https://x-access-token:$GITHUB_PAT@github.com/<repo>.git`
  - Create output directory: `ideas/YYYY-MM-DD-<slug>/`
  - Run Claude Code with prompt referencing template file and directing output to research.md
  - Configure git user and commit with message: `idea: <slug> - research complete`
  - Push to configured branch
  - Update job with github_url on success
- Files changed: src/index.ts
- **Learnings for future iterations:**
  - Use `x-access-token` as username for PAT-based git auth over HTTPS
  - Pass env vars to sandbox with setEnvVars() before running commands
  - Use `--depth 1` for shallow clone to speed up git operations
  - Escape newlines and quotes in shell prompts: `.replace(/"/g, '\\"').replace(/\n/g, '\\n')`
  - Import generateSlug from src/utils/slug.ts for consistent slug generation
---

## 2026-01-08 - US-009
Thread: https://ampcode.com/threads/T-019b9e3d-9827-716b-8588-18239a0e81cf
- Implemented webhook delivery system
- Created src/utils/webhook.ts with:
  - HMAC-SHA256 signature generation using Web Crypto API
  - Success payload builder with github_url and github_raw_url
  - Failure payload builder with error message
  - sendWebhook function that returns success status and statusCode
- Integrated webhook into runExploration flow in src/index.ts
- Webhooks sent on both completion and failure paths
- Files changed: src/utils/webhook.ts (new), src/index.ts
- **Learnings for future iterations:**
  - Use crypto.subtle.importKey + crypto.subtle.sign for HMAC in Workers environment
  - Webhook X-Signature header format: `sha256=<hex-encoded-hmac>`
  - Parse github_url to extract path for constructing raw.githubusercontent.com URL
---

## 2026-01-08 - US-010
Thread: https://ampcode.com/threads/T-019b9e40-0177-739e-8e8b-b5699d263e60
- Implemented webhook retry logic with exponential backoff
- Updated src/utils/webhook.ts to:
  - Retry up to 3 times on non-2xx responses
  - Use exponential backoff delays: 1s, 5s, 30s
  - Log each attempt as structured JSON with job_id, attempt, status_code, success
  - Return attempts count in sendWebhook result
- Files changed: src/utils/webhook.ts
- **Learnings for future iterations:**
  - Use `Promise<void>` sleep helper for delays between retries
  - sendWebhook now returns { success, statusCode, attempts } with attempts count
  - Structured logging via console.log(JSON.stringify({...})) for Cloudflare Workers
---

## 2026-01-08 - US-011
Thread: https://ampcode.com/threads/T-019b9e41-49c1-7239-a0ed-d8d4d924bd0d
- Implemented robust error handling throughout the exploration flow
- Added to src/index.ts:
  - `logError(jobId, operation, error)` - structured JSON error logging with job context
  - `logInfo(jobId, event, data?)` - structured JSON info logging with job context
  - `cloneWithRetry(sandbox, repoUrl, branch, jobId)` - retries clone once on failure
  - `pushWithRetry(sandbox, branch, repoUrl, jobId)` - retries push with `git pull --rebase` before second attempt
  - Timeout detection: checks error message for 'timeout'/'TIMEOUT'/'timed out' and reports user-friendly message
  - Claude errors wrapped with "Claude Code error:" prefix and included in failure webhook
- Files changed: src/index.ts
- **Learnings for future iterations:**
  - Use `ReturnType<typeof getSandbox>` to type the sandbox parameter in helper functions
  - For push retry, use `git pull --rebase` with full repoUrl before retrying push
  - Wrap Claude exec in try/catch separately to provide more specific error messages
  - Timeout detection is string-based; check for common patterns like 'timeout', 'TIMEOUT', 'timed out'
---
